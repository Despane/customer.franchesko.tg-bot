import { Context } from "telegraf";
import { UserService } from "../service/UserService";
import { Enterprise } from '../class/1cServer'
import * as path from 'path'
import dns from "dns";
function isValidUserName(name: string): boolean {
	// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∏–º–µ–Ω–∏ (2‚Äì50 —Å–∏–º–≤–æ–ª–æ–≤)
	if (name.length < 2 || name.length > 50) {
		return false;
	}

	// –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã
	const nameRegex = /^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s-]+$/;
	return nameRegex.test(name);
}
function isValidEmailFormat(email: string): boolean {
	// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã email (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 100)
	if (email.length < 6 || email.length > 100) {
		return false;
	}

	// –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±–∞–∑–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email
	const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	return emailRegex.test(email);
}

async function hasMxRecord(email: string): Promise<boolean> {
	const domain = email.split("@")[1];
	if (!domain) return false;

	try {
		const records = await dns.promises.resolveMx(domain);
		return records.length > 0;
	} catch {
		return false;
	}
}
const BUTTONS = {
	SEND_PHONE: {
		text: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
		request_contact: true,
	},
	CHANGE_PHON:{
		text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω",
	},
	REPEAT_CODE:{
		text: "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ",
	},
	LOGOUT: {
		text: "–í—ã–π—Ç–∏",
	},
	BALANCE: {
		text: "–ë–∞–ª–∞–Ω—Å",
	},
	QR_CODE: {
		text: "QR-–∫–æ–¥",
	},
	LAST_OPERATIONS: {
		text: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏",
	},
	CHANGE_MAIL: {
		text: "–°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É",
	},
	ACCII:{
	text: "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏",
}
};

const KEYBOARDS = {
	SEND_PHONE: {
		reply_markup: {
			keyboard: [[BUTTONS.SEND_PHONE]],
			resize_keyboard: true,
			one_time_keyboard: true,
		},
	},
	CHANGE_PHONE1: {
		reply_markup: {
			keyboard: [[BUTTONS.CHANGE_PHON]],
			resize_keyboard: true,
			one_time_keyboard: true,
		},
	},
	CHANGE_PHONE: {
		reply_markup: {
			keyboard: [[BUTTONS.REPEAT_CODE]],
			resize_keyboard: true,
			one_time_keyboard: true,
		},
	},
	AUTHORIZED: {
		reply_markup: {
			keyboard: [
				[BUTTONS.BALANCE, BUTTONS.QR_CODE],
				[BUTTONS.LAST_OPERATIONS, BUTTONS.LOGOUT,BUTTONS.CHANGE_MAIL,BUTTONS.ACCII],
			],
			resize_keyboard: true,
		},
	},
	REMOVE: {
		reply_markup: {
			remove_keyboard: true as true,
		},
	},

};


export class UserController {
	private userService: UserService;

	constructor(userService: UserService) {
		this.userService = userService;
	}

	public async handleStart(ctx: Context): Promise<void> {
		const userId = ctx.from?.id;

		if (!userId) return;

		const user = this.userService.getUserInfo(userId);

		if (!user) {
			this.userService.addUser(userId, "", "");
			this.userService.updateUserState(userId, "awaiting_phone");


				await ctx.reply(
					"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª—É–± –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π Francesco Donni! üí´ –¢–µ–ø–µ—Ä—å —à–æ–ø–∏–Ω–≥ —Å—Ç–∞–ª –µ—â–µ –≤—ã–≥–æ–¥–Ω–µ–π! üéÅ\n\n" +
					"–Ø –æ—Ç–≤–µ—á—É –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã, —Å–º–æ–≥—É —É–≤–µ–¥–æ–º–ª—è—Ç—å –æ–± –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞–∫—Ü–∏—è—Ö, –ø—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã.\n\n" +
					"–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
				KEYBOARDS.SEND_PHONE
			);
		} else if (user.state === "awaiting_phone") {
			await ctx.reply(
				"–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
				KEYBOARDS.SEND_PHONE
			);
		} else if (user.state === "awaiting_code") {
			await ctx.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",KEYBOARDS.REMOVE);
		} else if (user.state === "authorized") {
			await ctx.reply("–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ", KEYBOARDS.AUTHORIZED);
		}
	}

	public async handleContact(ctx: Context): Promise<void> {
		const userId = ctx.from?.id;

		if (!userId) return;

		if (ctx.message && "contact" in ctx.message) {
			const contact = ctx.message.contact;

			if (contact && contact.phone_number) {
				let user = this.userService.getUserInfo(userId);

				if (user && user.state === "awaiting_phone") {
					try {
						let tempUser = await Enterprise.getCardByPhone(contact.phone_number);

						if (tempUser) {
							// –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º
							try{this.userService.addUser(userId, tempUser[1], contact.phone_number);
								this.userService.updateUserCode(userId,tempUser[0])
								const code = this.userService.generateVerificationCode(userId,contact.phone_number);
								//console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${code}`);
								this.userService.updateUserState(userId, "awaiting_code");
								await ctx.reply(`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${contact.phone_number}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ`, KEYBOARDS.REMOVE
								);
								await ctx.reply(
									`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.`,{
										reply_markup: {
											inline_keyboard: [
												[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
											]
										}
									}
								);
								setTimeout(async () => {
									// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
									if (user?.state === 'awaiting_code') {
										await ctx.reply(
											"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
											KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
										);
									}
								}, 60000);
							}
							catch (e) {
								await ctx.reply(
									`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${contact.phone_number}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
										reply_markup: {
											inline_keyboard: [
												[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
											]
										}
									}
								)
								this.userService.addUser(userId, "", "");
								this.userService.updateUserState(userId, "unauthorized");

								setTimeout(async () => {
									// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
									if (user?.state === 'awaiting_code') {
										await ctx.reply(
											"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
											KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
										);
									}
								}, 60000);
							}
						} else {
							throw new Error("–î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
						}
					} catch (error) {
						console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
						// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
						try{const code = this.userService.generateVerificationCode(userId,contact.phone_number);
							//console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${code}`);
							this.userService.addUser(userId, "", contact.phone_number);
							this.userService.updateUserState(userId, "awaiting_code");
							await ctx.reply(`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${contact.phone_number}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ`, KEYBOARDS.REMOVE
							);
							await ctx.reply(
								`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
									reply_markup: {
										inline_keyboard: [
											[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
										]
									}
								}
							);
							setTimeout(async () => {
								// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
								if (user?.state === 'awaiting_code') {
									await ctx.reply(
										"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
										KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
									);
								}
							}, 60000);
						}
						catch (e) {
							await ctx.reply(`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${contact.phone_number}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ`, KEYBOARDS.REMOVE
							);
							await ctx.reply(
								`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
									reply_markup: {
										inline_keyboard: [
											[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
										]
									}
								}
							)
							this.userService.addUser(userId, "", "");
							this.userService.updateUserState(userId, "unauthorized");

							setTimeout(async () => {
								// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
								if (user?.state === 'awaiting_code') {
									await ctx.reply(
										"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
										KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
									);
								}
							}, 60000);
						}
					}
				} else if (user && user.state === "authorized") {
					await ctx.reply("–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í—ã–±–µ—Ä–∏—Ç–µ /start –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã?");
				}
			} else {
				await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
			}
		} else {
			await ctx.reply("–û–∂–∏–¥–∞–ª—Å—è –∫–æ–Ω—Ç–∞–∫—Ç, –Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ–≥–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç.");
		}
	}

	public async handleText(ctx: Context): Promise<void> {
		const userId = ctx.from?.id;

		if (!userId) return;

		const messageText = ctx.message && "text" in ctx.message ? ctx.message.text : null;

		if (!messageText) {
			ctx.reply("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");
			return;
		}

		const user = this.userService.getUserInfo(userId);

		if (!user) {
			await ctx.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start.");
			return;
		}

		if (user.state === "authorized") {
			switch (messageText) {
				case BUTTONS.BALANCE.text:
					try {
						const balanceData = await Enterprise.getBalanceByCode(user.code!);

						// –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
						let responseText = `–í–∞—à –±–∞–ª–∞–Ω—Å: ${balanceData.balance} ‚ÇΩ`;

						if (balanceData.plannedDescriptions.length > 0) {
							responseText += `\n\nüìÖ *–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤:*\n`;
							responseText += balanceData.plannedDescriptions.map((desc:string) => `- ${desc}`).join("\n");
						} else {
							responseText += `\n\n‚úÖ –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π.`;
						}
						await ctx.reply(responseText, { parse_mode: "Markdown" });
					} catch (error) {
						console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:", error);
						await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
					}
					return;
				case BUTTONS.QR_CODE.text:
					try {
						if(user.code){
						const qr = await Enterprise.getQRCard(user.code);
						const filePath = path.join(__dirname,'..', 'class', 'cache', qr);
						await ctx.reply("–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –∫–∞—Å—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤.");
						await ctx.replyWithPhoto({ source: filePath });
					}
						else{
							await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å qr-–∫–æ–¥. –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
						}
					}
					catch (error) {
						console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è qr-–∫–æ–¥–∞:", error);
						await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å qr-–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
					}
					return;
				case BUTTONS.LAST_OPERATIONS.text:
					try {
						if(user.code){
						const history = await Enterprise.getHistory(user.code);
						//console.log(history)
						if (!history||!history.length) {
							await ctx.reply("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.");
							return;
						}

						let escapeMarkdown = (text:any) => {
							return text.replace(/[_*[\]()~`>#+\-=|{}.!]/g, "\\$&");// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ MarkdownV2
						};

						let message = "üìú *–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –±–æ–Ω—É—Å–æ–≤:*\n\n";

						history.forEach((entry:any) => {
							const date = new Date(entry.date).toISOString().split("T")[0].split("-").reverse().join(".");
							message += `üìÖ *–î–∞—Ç–∞:* ${escapeMarkdown(date)}\n`;
							message += `üîπ *–û–ø–∏—Å–∞–Ω–∏–µ:* ${escapeMarkdown(entry.description)}\n`;
							message += `üí∞ *–ë–∞–ª–ª—ã:* ${entry.total > 0 ? `\\+${escapeMarkdown(entry.total.toString())}` : escapeMarkdown(entry.total.toString())} –±–∞–ª–ª–æ–≤\n`;
							message += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
						});

						await ctx.replyWithMarkdownV2(message);}
						else{
							await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å. –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
						}
					} catch (error) {
						console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:", error);
						await ctx.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
					}
					return;
				case BUTTONS.LOGOUT.text:
					this.userService.removeUser(userId);
					await ctx.reply(
						"–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start.",
						KEYBOARDS.REMOVE
					);
					return;
				case BUTTONS.CHANGE_MAIL.text:
					this.userService.updateUserState(userId, "awaiting_mail_adress");
					await ctx.reply(
						"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ—á—Ç—É. –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –º–µ–Ω—é –≤–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∫—Ä–æ–º–µ –ø–æ—á—Ç—ã"
					);
					return;
				case BUTTONS.ACCII.text:
					// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–Ω–æ–ø–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –≤–µ–¥–µ—Ç –ø–æ —Å—Å—ã–ª–∫–µ
					await ctx.reply(
						"–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∞–∫—Ü–∏—è–º:",
						{
							reply_markup: {
								inline_keyboard: [
									[
										{
											text: "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏",  // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
											url: "https://francesco.ru/aktsii/"  // –°—Å—ã–ª–∫–∞
										},
									],
								],
							},
						}
					);
					return;
				default:
					await ctx.reply("–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í—ã–±–µ—Ä–∏—Ç–µ /start –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã?", KEYBOARDS.AUTHORIZED);
					return;
			}
		}
		if(user.state === "awaiting_mail_adress"){
			try {
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç email
				if (!isValidEmailFormat(messageText)) {
					await ctx.reply(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é`,KEYBOARDS.AUTHORIZED);
					this.userService.updateUserState(userId, "authorized");
					return;
				}
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º MX-–∑–∞–ø–∏—Å—å
				const isDomainValid = await hasMxRecord(messageText);
				if (!isDomainValid) {
					await ctx.reply(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é`,KEYBOARDS.AUTHORIZED);
					this.userService.updateUserState(userId, "authorized");
					return;
				}
				// –ï—Å–ª–∏ email –≤–∞–ª–∏–¥–µ–Ω ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
				let regUser = await Enterprise.updateCardDetailsByPhone(user.phone, messageText, user.id);
				this.userService.updateUserState(userId, "authorized");
				if (regUser){
					await ctx.reply(`–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`, KEYBOARDS.AUTHORIZED);
					return;
				}
			} catch (e) {
				//console.log(e)
				await ctx.reply(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
				this.userService.updateUserState(userId, "authorized");
				return;
			}
		}
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		if (user.state === "awaiting_phone") {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
			const phoneRegex = /^(\+7|7|8)\d{10}$/; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç E.164
			if (phoneRegex.test(messageText)) {
				try {
					let tempUser = await Enterprise.getCardByPhone(messageText);

					if (tempUser) {
						// –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º
						try{
							this.userService.addUser(userId, tempUser[1], messageText);
							this.userService.updateUserCode(userId,tempUser[0])
							const code = this.userService.generateVerificationCode(userId,messageText);
							//console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${code}`);
							this.userService.updateUserState(userId, "awaiting_code");
							await ctx.reply(`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${messageText}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ`, KEYBOARDS.REMOVE
							);
							await ctx.reply(
								`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.`,{
									reply_markup: {
										inline_keyboard: [
											[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
										]
									}
								}
							);

							setTimeout(async () => {
								// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
								if (user?.state === 'awaiting_code') {
									await ctx.reply(
										"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
										KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
									);
								}
							}, 60000);

						}
						catch (e) {
							await ctx.reply(
								`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${messageText}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
									reply_markup: {
										inline_keyboard: [
											[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
										]
									}
								}
							)
							this.userService.addUser(userId, "", "");
							this.userService.updateUserState(userId, "unauthorized");

							setTimeout(async () => {
								// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
								if (user.state === "awaiting_code") {
									await ctx.reply(
										"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
										KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
									);
								}
							}, 60000);
						}
					} else {
						throw new Error("–î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
					}
				} catch (error) {
					console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
					// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
					try{const code = this.userService.generateVerificationCode(userId,messageText);
						//console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${code}`);
						this.userService.addUser(userId, "", messageText);
						this.userService.updateUserState(userId, "awaiting_code");
						await ctx.reply(`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${messageText}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ`, KEYBOARDS.REMOVE
						);
						await ctx.reply(
							`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
								reply_markup: {
									inline_keyboard: [
										[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
									]
								}
							}
						);
						setTimeout(async () => {
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
							if (user?.state === 'awaiting_code') {
								await ctx.reply(
									"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
									KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
								);
							}
						}, 60000);
					}
					catch (e) {
						await ctx.reply(
							`–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${messageText}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω! ‚úÖ –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º –∫–æ–¥, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.`,{
								reply_markup: {
									inline_keyboard: [
										[{ text: "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data: "change_phone" }]
									]
								}
							}
						);
						this.userService.addUser(userId, "", "");
						this.userService.updateUserState(userId, "unauthorized");
						setTimeout(async () => {
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
							if (user.state === "awaiting_code") {
								await ctx.reply(
									"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
									KEYBOARDS.CHANGE_PHONE  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
								);
							}
						}, 60000);
					}
				}
			} else {
				await ctx.reply("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, +123456789).");
			}
		}
		else if (user.state === "awaiting_code") {
			// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫
			if (messageText === BUTTONS.CHANGE_PHON.text) {
				// –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
				this.userService.addUser(userId,'','')
				this.userService.updateUserState(userId, "awaiting_phone");
				this.userService.updateUserCode(userId,"")
				await ctx.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.", KEYBOARDS.SEND_PHONE);
				return;
			} else if (messageText === BUTTONS.REPEAT_CODE.text) {
				// –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
				this.userService.resetFailedAttempts(userId);
				this.userService.generateVerificationCode(userId,user.phone)// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
				await ctx.reply("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω.");
				return;
				// –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
			} else {
				// –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞, —Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
				const isCodeValid = this.userService.verifyCode(userId, messageText);
				//console.log(user.code)
				if (isCodeValid) {
					if (user.code) {
						// –ï—Å–ª–∏ –∫–æ–¥ –≤–µ—Ä–Ω—ã–π, –¥–∞–ª–µ–µ –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
						this.userService.updateUserState(userId, "authorized");
						await ctx.reply("–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. ‚úÖ", KEYBOARDS.AUTHORIZED);
						await ctx.reply(
							"–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã\\. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ:\n\n" +
							"1\\) –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ ‚Äì *–ë–∞–ª–∞–Ω—Å* ‚ú®\n" +
							"2\\) —Å–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –ø–æ–∫–∞–∑–∞–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –≤–∞—à QR\\-–∫–æ–¥ ‚Äì *QR –∫–æ–¥* üõçÔ∏è\n" +
							"3\\) –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –∏ —Å–ø–∏—Å–∞–Ω–∏–π ‚Äì *–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏* üìí\n" +
							"4\\) –≤—ã–π—Ç–∏ –∏–∑ —É—á–µ—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –±–æ—Ç–∞ ‚Äì *–í—ã–π—Ç–∏* ‚úñÔ∏è\n" +
							"5\\) –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à—É –ø–æ—á—Ç—É ‚Äì *–°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É* üì©",
							{
								parse_mode: "MarkdownV2",
							}
						);

						try {
							let auth = await Enterprise.updateCardDetailsByPhone(user.phone, '', userId);
						}
						catch (e) {
							// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
						}
					}
					else {
						this.userService.updateUserState(userId, "awaiting_name");
						this.userService.resetFailedAttempts(userId); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
						await ctx.reply("–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. ‚úÖÔ∏è–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.");
					}
				} else {
					// –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
					const attemptsLeft = this.userService.incrementFailedAttempts(userId);

					if (attemptsLeft > 0) {
						await ctx.reply(
							`–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å ${attemptsLeft} ${attemptsLeft === 1 ? "–ø–æ–ø—ã—Ç–∫–∞" : "–ø–æ–ø—ã—Ç–∫–∏"}.`
						);
					} else {
						// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
						this.userService.updateUserState(userId, "awaiting_phone");
						this.userService.resetFailedAttempts(userId); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
						await ctx.reply(
							"–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≤–≤–æ–¥–∞ –∫–æ–¥–∞. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å –∑–∞–Ω–æ–≤–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
							KEYBOARDS.SEND_PHONE
						);
					}
				}
			}
		}
		else if (user.state === "awaiting_name") {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
			if (!isValidUserName(messageText)) {
				await ctx.reply("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã, –¥–ª–∏–Ω–∞ –æ—Ç 2 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤.");
				return;
			}
			this.userService.addUser(userId, messageText, user.phone);
			this.userService.updateUserState(userId, "awaiting_mail");
			await ctx.reply(`–°–ø–∞—Å–∏–±–æ, ${messageText}! –¢–µ–ø–µ—Ä—å –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –≤–≤–µ—Å—Ç–∏ –ø–æ—á—Ç—É`, KEYBOARDS.REMOVE);
		}
		else if (user.state === "awaiting_mail") {
			try {
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç email
				if (!isValidEmailFormat(messageText)) {
					await ctx.reply(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.`);
					return;
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º MX-–∑–∞–ø–∏—Å—å
				const isDomainValid = await hasMxRecord(messageText);
				if (!isDomainValid) {
					await ctx.reply(`–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ email –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.`);
					return;
				}

				// –ï—Å–ª–∏ email –≤–∞–ª–∏–¥–µ–Ω ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
				let regUser = await Enterprise.addNewCard(user.name, user.phone, messageText, user.id);
				this.userService.updateUserCode(userId, regUser);
				this.userService.updateUserState(userId, "authorized");
				await ctx.reply(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –ò–º—è! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ`, KEYBOARDS.AUTHORIZED);
			} catch (e) {
				await ctx.reply(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
				this.userService.updateUserState(userId, "unauthorized");
				this.userService.addUser(userId, "", "");
			}
		}
		else if (user.state === "authorized") {
			if (messageText === BUTTONS.LOGOUT.text) {
				this.userService.updateUserState(userId, "awaiting_phone");

				await ctx.reply(
					"–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start.",
					KEYBOARDS.REMOVE
				);
			} else {

				await ctx.reply("–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í—ã–±–µ—Ä–∏—Ç–µ /start –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã?");
			}
		}
		else {

			await ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å —Å –∫–æ–º–∞–Ω–¥—ã /start.");
		}
	}

	public async handleLogout(ctx: Context): Promise<void> {
		const userId = ctx.from?.id;

		if (!userId) return;

		const user = this.userService.getUserInfo(userId);

		if (!user || user.state !== "authorized") {
			await ctx.reply("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏–ª–∏ —É–∂–µ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.");
			return;
		}

		this.userService.removeUser(userId); // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

		await ctx.reply(
			"–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start.",
			KEYBOARDS.REMOVE
		);
	}
	public async handlePhone(ctx: Context): Promise<void> {
		const userId = ctx.from?.id;
		await ctx.answerCbQuery();
		if (!userId) return;
		const user = this.userService.getUserInfo(userId);
		if (!user) {
			await ctx.reply("–ø—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞");
			return;
		}
		this.userService.addUser(userId,'','')
		this.userService.updateUserState(userId, "awaiting_phone");
		this.userService.updateUserCode(userId,"")
		await ctx.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.", KEYBOARDS.SEND_PHONE);
	}
}
